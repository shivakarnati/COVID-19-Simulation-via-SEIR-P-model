Object.defineProperty(exports, '__esModule', {
  value: true
});
exports.activate = activate;
exports.deactivate = deactivate;
exports.consumeStatusBar = consumeStatusBar;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) arr2[i] = arr[i]; return arr2; } else { return Array.from(arr); } }

var _atom = require('atom');

var _status = require('./status');

var _status2 = _interopRequireDefault(_status);

var _selector = require('./selector');

var _selector2 = _interopRequireDefault(_selector);

'use babel';

var possibleIndentations = [];
var enableDebug = false;
var manual = new Set();
var subs = undefined;

function activate() {
  subs = new _atom.CompositeDisposable();
  _status2['default'].activate();

  subs.add(atom.workspace.observeTextEditors(function (ed) {
    run(ed);
    var sub = ed.onDidStopChanging(function () {
      run(ed);
    });
    subs.add(ed.onDidDestroy(function () {
      sub.dispose();
      manual['delete'](ed);
    }));
  }), atom.workspace.onDidStopChangingActivePaneItem(function (item) {
    if (item instanceof _atom.TextEditor) {
      run(item);
    } else {
      _status2['default'].update();
    }
  }), atom.commands.add('atom-text-editor', {
    'indent-detective:choose-indent': function indentDetectiveChooseIndent() {
      return select();
    }
  }), atom.config.observe('indent-detective.possibleIndentations', function (opts) {
    possibleIndentations = opts.map(function (el) {
      return parseInt(el);
    });
  }), atom.config.observe('indent-detective.enableDebugMessages', function (val) {
    enableDebug = val;
  }));
}

function deactivate() {
  subs.dispose();
  manual.clear();
  _status2['default'].deactivate();
}

function consumeStatusBar(bar) {
  _status2['default'].consumeStatusBar(bar);
}

function run(editor) {
  if (editor.isDestroyed()) return;
  if (!manual.has(editor)) {
    setSettings(editor, getIndent(editor));
  }

  _status2['default'].update(editor);
}

function setSettings(editor, indent) {
  if (enableDebug) {
    console.log('-> decided for ' + indent);
  }
  if (indent == 0) return; // default settings

  if (indent == 'tab') {
    editor.setSoftTabs(false);
  } else if (indent >= Math.min.apply(Math, _toConsumableArray(possibleIndentations)) && indent <= Math.max.apply(Math, _toConsumableArray(possibleIndentations))) {
    editor.setSoftTabs(true);
    editor.setTabLength(indent);
  }
}

function bestOf(counts) {
  var best = 0;
  var score = 0;
  for (var vote in counts) {
    vote = parseInt(vote);
    if (possibleIndentations.indexOf(vote) > -1 && counts[vote] > score) {
      best = vote;
      score = counts[vote];
    }
  }
  return best;
}

function getIndent(editor) {
  var row = -1;
  var counts = {};
  var previousIndent = 0;
  var previousDiff = 0;
  var numberOfCounts = 0;
  for (var line of editor.getBuffer().getLines()) {
    if (numberOfCounts > 150) break;
    row += 1;
    if (!isValidLine(row, line, editor)) continue;
    var indent = lineIndent(line);

    if (indent == 'tab') return 'tab';
    var diff = Math.abs(indent - previousIndent);

    if (diff == 0) {
      if (previousDiff != 0 && indent != 0) {
        counts[previousDiff] += 1;
      }
    } else {
      if (!counts[diff]) counts[diff] = 0;
      counts[diff] += 1;
      previousDiff = diff;
    }

    previousIndent = indent;
    numberOfCounts += 1;
  }
  if (enableDebug) {
    console.log('Indent Detective report for ' + editor.buffer.getBaseName());
    console.log(counts);
  }
  return bestOf(counts);
}

function isValidLine(row, line, editor) {
  // empty line
  if (line.match(/^\s*$/)) return false;

  // line is part of a comment or string
  for (var scope of editor.scopeDescriptorForBufferPosition([row, 0]).scopes) {
    if (scope.indexOf('comment') > -1 || scope.indexOf('docstring') > -1 || scope.indexOf('string') > -1) {
      return false;
    }
  }

  return true;
}

function lineIndent(line) {
  if (line.match(/^\t+/)) {
    return 'tab';
  } else {
    return line.match(/^([ ]*)/)[0].length;
  }
}

function select() {
  var items = [{ text: 'Automatic' }];
  for (var n of possibleIndentations) {
    items.push({ text: n + ' Spaces', length: n });
  }
  items.push({ text: 'Tabs', length: 'tab' });
  _selector2['default'].show(items, function () {
    var _ref = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    var text = _ref.text;
    var length = _ref.length;

    var editor = atom.workspace.getActiveTextEditor();
    if (text == 'Automatic') {
      manual['delete'](editor);
      run(editor);
    } else {
      setSettings(editor, length);
      manual.add(editor);
      _status2['default'].update(editor);
    }
  });
}

var config = {
  possibleIndentations: {
    type: 'array',
    // HACK: array of strings because settings-view is broken
    'default': ['2', '3', '4', '6', '8'],
    items: {
      type: 'string'
    },
    order: 1
  },
  enableDebugMessages: {
    type: 'boolean',
    'default': false,
    order: 2
  }
};
exports.config = config;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL3NoaXZha3Jpc2huYWthcm5hdGkvLnZhci9hcHAvaW8uYXRvbS5BdG9tL2RhdGEvcGFja2FnZXMvaW5kZW50LWRldGVjdGl2ZS9saWIvaW5kZW50LWRldGVjdGl2ZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztvQkFFZ0QsTUFBTTs7c0JBQ25DLFVBQVU7Ozs7d0JBQ1IsWUFBWTs7OztBQUpqQyxXQUFXLENBQUE7O0FBTVgsSUFBSSxvQkFBb0IsR0FBRyxFQUFFLENBQUE7QUFDN0IsSUFBSSxXQUFXLEdBQUcsS0FBSyxDQUFBO0FBQ3ZCLElBQU0sTUFBTSxHQUFHLElBQUksR0FBRyxFQUFFLENBQUE7QUFDeEIsSUFBSSxJQUFJLFlBQUEsQ0FBQTs7QUFFRCxTQUFTLFFBQVEsR0FBSTtBQUMxQixNQUFJLEdBQUcsK0JBQXlCLENBQUE7QUFDaEMsc0JBQU8sUUFBUSxFQUFFLENBQUE7O0FBRWpCLE1BQUksQ0FBQyxHQUFHLENBQ04sSUFBSSxDQUFDLFNBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxVQUFDLEVBQUUsRUFBSztBQUN4QyxPQUFHLENBQUMsRUFBRSxDQUFDLENBQUE7QUFDUCxRQUFNLEdBQUcsR0FBRyxFQUFFLENBQUMsaUJBQWlCLENBQUMsWUFBTTtBQUNyQyxTQUFHLENBQUMsRUFBRSxDQUFDLENBQUE7S0FDUixDQUFDLENBQUE7QUFDRixRQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsWUFBTTtBQUM3QixTQUFHLENBQUMsT0FBTyxFQUFFLENBQUE7QUFDYixZQUFNLFVBQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQTtLQUNsQixDQUFDLENBQUMsQ0FBQTtHQUNKLENBQUMsRUFDRixJQUFJLENBQUMsU0FBUyxDQUFDLCtCQUErQixDQUFDLFVBQUMsSUFBSSxFQUFLO0FBQ3ZELFFBQUksSUFBSSw0QkFBc0IsRUFBRTtBQUM5QixTQUFHLENBQUMsSUFBSSxDQUFDLENBQUE7S0FDVixNQUFNO0FBQ0ws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RUFBRSxLQUFLLEVBQUMsQ0FBQyxDQUFBO0FBQ3pDLHdCQUFTLElBQUksQ0FBQyxLQUFLLEVBQUUsWUFBc0I7cUVBQU4sRUFBRTs7UUFBaEIsSUFBSSxRQUFKLElBQUk7UUFBRSxNQUFNLFFBQU4sTUFBTTs7QUFDakMsUUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsRUFBRSxDQUFBO0FBQ25ELFFBQUksSUFBSSxJQUFJLFdBQVcsRUFBRTtBQUN2QixZQUFNLFVBQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtBQUNyQixTQUFHLENBQUMsTUFBTSxDQUFDLENBQUE7S0FDWixNQUFNO0FBQ0wsaUJBQVcsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUE7QUFDM0IsWUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQTtBQUNsQiwwQkFBTyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUE7S0FDdEI7R0FDRixDQUFDLENBQUE7Q0FDSDs7QUFFTSxJQUFJLE1BQU0sR0FBRztBQUNsQixzQkFBb0IsRUFBRTtBQUNwQixRQUFJLEVBQUUsT0FBTzs7QUFFYixlQUFTLENBQUMsR0FBRyxFQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQztBQUNqQyxTQUFLLEVBQUU7QUFDTCxVQUFJLEVBQUUsUUFBUTtLQUNmO0FBQ0QsU0FBSyxFQUFFLENBQUM7R0FDVDtBQUNELHFCQUFtQixFQUFFO0FBQ25CLFFBQUksRUFBRSxTQUFTO0FBQ2YsZUFBUyxLQUFLO0FBQ2QsU0FBSyxFQUFFLENBQUM7R0FDVDtDQUNGLENBQUEiLCJmaWxlIjoiL2hvbWUvc2hpdmFrcmlzaG5ha2FybmF0aS8udmFyL2FwcC9pby5hdG9tLkF0b20vZGF0YS9wYWNrYWdlcy9pbmRlbnQtZGV0ZWN0aXZlL2xpYi9pbmRlbnQtZGV0ZWN0aXZlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCdcblxuaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSwgVGV4dEVkaXRvciB9IGZyb20gJ2F0b20nXG5pbXBvcnQgc3RhdHVzIGZyb20gJy4vc3RhdHVzJ1xuaW1wb3J0IHNlbGVjdG9yIGZyb20gJy4vc2VsZWN0b3InXG5cbmxldCBwb3NzaWJsZUluZGVudGF0aW9ucyA9IFtdXG5sZXQgZW5hYmxlRGVidWcgPSBmYWxzZVxuY29uc3QgbWFudWFsID0gbmV3IFNldCgpXG5sZXQgc3Vic1xuXG5leHBvcnQgZnVuY3Rpb24gYWN0aXZhdGUgKCkge1xuICBzdWJzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICBzdGF0dXMuYWN0aXZhdGUoKVxuXG4gIHN1YnMuYWRkKFxuICAgIGF0b20ud29ya3NwYWNlLm9ic2VydmVUZXh0RWRpdG9ycygoZWQpID0+IHtcbiAgICAgIHJ1bihlZClcbiAgICAgIGNvbnN0IHN1YiA9IGVkLm9uRGlkU3RvcENoYW5naW5nKCgpID0+IHtcbiAgICAgICAgcnVuKGVkKVxuICAgICAgfSlcbiAgICAgIHN1YnMuYWRkKGVkLm9uRGlkRGVzdHJveSgoKSA9PiB7XG4gICAgICAgIHN1Yi5kaXNwb3NlKClcbiAgICAgICAgbWFudWFsLmRlbGV0ZShlZClcbiAgICAgIH0pKVxuICAgIH0pLFxuICAgIGF0b20ud29ya3NwYWNlLm9uRGlkU3RvcENoYW5naW5nQWN0aXZlUGFuZUl0ZW0oKGl0ZW0pID0+IHtcbiAgICAgIGlmIChpdGVtIGluc3RhbmNlb2YgVGV4dEVkaXRvcikge1xuICAgICAgICBydW4oaXRlbSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHN0YXR1cy51cGRhdGUoKVxuICAgICAgfVxuICAgIH0pLFxuICAgIGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXRleHQtZWRpdG9yJywge1xuICAgICAgJ2luZGVudC1kZXRlY3RpdmU6Y2hvb3NlLWluZGVudCc6ICgpID0+IHNlbGVjdCgpXG4gICAgfSksXG4gICAgYXRvbS5jb25maWcub2JzZXJ2ZSgnaW5kZW50LWRldGVjdGl2ZS5wb3NzaWJsZUluZGVudGF0aW9ucycsIChvcHRzKSA9PiB7XG4gICAgICBwb3NzaWJsZUluZGVudGF0aW9ucyA9IG9wdHMubWFwKGVsID0+IHBhcnNlSW50KGVsKSlcbiAgICB9KSxcbiAgICBhdG9tLmNvbmZpZy5vYnNlcnZlKCdpbmRlbnQtZGV0ZWN0aXZlLmVuYWJsZURlYnVnTWVzc2FnZXMnLCAodmFsKSA9PiB7XG4gICAgICBlbmFibGVEZWJ1ZyA9IHZhbFxuICAgIH0pXG4gIClcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlYWN0aXZhdGUgKCkge1xuICBzdWJzLmRpc3Bvc2UoKVxuICBtYW51YWwuY2xlYXIoKVxuICBzdGF0dXMuZGVhY3RpdmF0ZSgpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb25zdW1lU3RhdHVzQmFyIChiYXIpIHtcbiAgc3RhdHVzLmNvbnN1bWVTdGF0dXNCYXIoYmFyKVxufVxuXG5mdW5jdGlvbiBydW4gKGVkaXRvcikge1xuICBpZiAoZWRpdG9yLmlzRGVzdHJveWVkKCkpIHJldHVyblxuICBpZiAoIW1hbnVhbC5oYXMoZWRpdG9yKSkge1xuICAgIHNldFNldHRpbmdzKGVkaXRvciwgZ2V0SW5kZW50KGVkaXRvcikpXG4gIH1cblxuICBzdGF0dXMudXBkYXRlKGVkaXRvcilcbn1cblxuZnVuY3Rpb24gc2V0U2V0dGluZ3MgKGVkaXRvciwgaW5kZW50KSB7XG4gIGlmIChlbmFibGVEZWJ1Zykge1xuICAgIGNvbnNvbGUubG9nKGAtPiBkZWNpZGVkIGZvciAke2luZGVudH1gKVxuICB9XG4gIGlmIChpbmRlbnQgPT0gMCkgcmV0dXJuIC8vIGRlZmF1bHQgc2V0dGluZ3NcblxuICBpZiAoaW5kZW50ID09ICd0YWInKSB7XG4gICAgZWRpdG9yLnNldFNvZnRUYWJzKGZhbHNlKVxuICB9IGVsc2UgaWYgKGluZGVudCA+PSBNYXRoLm1pbiguLi5wb3NzaWJsZUluZGVudGF0aW9ucykgJiYgaW5kZW50IDw9IE1hdGgubWF4KC4uLnBvc3NpYmxlSW5kZW50YXRpb25zKSkge1xuICAgIGVkaXRvci5zZXRTb2Z0VGFicyh0cnVlKVxuICAgIGVkaXRvci5zZXRUYWJMZW5ndGgoaW5kZW50KVxuICB9XG59XG5cbmZ1bmN0aW9uIGJlc3RPZiAoY291bnRzKSB7XG4gIGxldCBiZXN0ID0gMFxuICBsZXQgc2NvcmUgPSAwXG4gIGZvciAobGV0IHZvdGUgaW4gY291bnRzKSB7XG4gICAgdm90ZSA9IHBhcnNlSW50KHZvdGUpXG4gICAgaWYgKHBvc3NpYmxlSW5kZW50YXRpb25zLmluZGV4T2Yodm90ZSkgPiAtMSAmJlxuICAgICAgICBjb3VudHNbdm90ZV0gPiBzY29yZSkge1xuICAgICAgYmVzdCA9IHZvdGVcbiAgICAgIHNjb3JlID0gY291bnRzW3ZvdGVdXG4gICAgfVxuICB9XG4gIHJldHVybiBiZXN0XG59XG5cbmZ1bmN0aW9uIGdldEluZGVudCAoZWRpdG9yKSB7XG4gIGxldCByb3cgPSAtMVxuICBjb25zdCBjb3VudHMgPSB7fVxuICBsZXQgcHJldmlvdXNJbmRlbnQgPSAwXG4gIGxldCBwcmV2aW91c0RpZmYgPSAwXG4gIGxldCBudW1iZXJPZkNvdW50cyA9IDBcbiAgZm9yIChjb25zdCBsaW5lIG9mIGVkaXRvci5nZXRCdWZmZXIoKS5nZXRMaW5lcygpKSB7XG4gICAgaWYgKG51bWJlck9mQ291bnRzID4gMTUwKSBicmVha1xuICAgIHJvdyArPSAxXG4gICAgaWYgKCFpc1ZhbGlkTGluZShyb3csIGxpbmUsIGVkaXRvcikpIGNvbnRpbnVlXG4gICAgY29uc3QgaW5kZW50ID0gbGluZUluZGVudChsaW5lKVxuXG4gICAgaWYgKGluZGVudCA9PSAndGFiJykgcmV0dXJuICd0YWInXG4gICAgY29uc3QgZGlmZiA9IE1hdGguYWJzKGluZGVudCAtIHByZXZpb3VzSW5kZW50KVxuXG4gICAgaWYgKGRpZmYgPT0gMCkge1xuICAgICAgaWYgKHByZXZpb3VzRGlmZiAhPSAwICYmIGluZGVudCAhPSAwKSB7XG4gICAgICAgIGNvdW50c1twcmV2aW91c0RpZmZdICs9IDFcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFjb3VudHNbZGlmZl0pIGNvdW50c1tkaWZmXSA9IDBcbiAgICAgIGNvdW50c1tkaWZmXSArPSAxXG4gICAgICBwcmV2aW91c0RpZmYgPSBkaWZmXG4gICAgfVxuXG4gICAgcHJldmlvdXNJbmRlbnQgPSBpbmRlbnRcbiAgICBudW1iZXJPZkNvdW50cyArPSAxXG4gIH1cbiAgaWYgKGVuYWJsZURlYnVnKSB7XG4gICAgY29uc29sZS5sb2coYEluZGVudCBEZXRlY3RpdmUgcmVwb3J0IGZvciAke2VkaXRvci5idWZmZXIuZ2V0QmFzZU5hbWUoKX1gKVxuICAgIGNvbnNvbGUubG9nKGNvdW50cylcbiAgfVxuICByZXR1cm4gYmVzdE9mKGNvdW50cylcbn1cblxuZnVuY3Rpb24gaXNWYWxpZExpbmUgKHJvdywgbGluZSwgZWRpdG9yKSB7XG4gIC8vIGVtcHR5IGxpbmVcbiAgaWYgKGxpbmUubWF0Y2goL15cXHMqJC8pKSByZXR1cm4gZmFsc2VcblxuICAvLyBsaW5lIGlzIHBhcnQgb2YgYSBjb21tZW50IG9yIHN0cmluZ1xuICBmb3IgKGNvbnN0IHNjb3BlIG9mIGVkaXRvci5zY29wZURlc2NyaXB0b3JGb3JCdWZmZXJQb3NpdGlvbihbcm93LCAwXSkuc2NvcGVzKSB7XG4gICAgaWYgKHNjb3BlLmluZGV4T2YoJ2NvbW1lbnQnKSA+IC0xIHx8XG4gICAgICAgIHNjb3BlLmluZGV4T2YoJ2RvY3N0cmluZycpID4gLTEgfHxcbiAgICAgICAgc2NvcGUuaW5kZXhPZignc3RyaW5nJykgPiAtMSkge1xuICAgICAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiB0cnVlXG59XG5cbmZ1bmN0aW9uIGxpbmVJbmRlbnQgKGxpbmUpIHtcbiAgaWYgKGxpbmUubWF0Y2goL15cXHQrLykpIHtcbiAgICByZXR1cm4gJ3RhYidcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gbGluZS5tYXRjaCgvXihbIF0qKS8pWzBdLmxlbmd0aFxuICB9XG59XG5cbmZ1bmN0aW9uIHNlbGVjdCAoKSB7XG4gIGNvbnN0IGl0ZW1zID0gW3t0ZXh0OiAnQXV0b21hdGljJ31dXG4gIGZvciAoY29uc3QgbiBvZiBwb3NzaWJsZUluZGVudGF0aW9ucykge1xuICAgIGl0ZW1zLnB1c2goe3RleHQ6IGAke259IFNwYWNlc2AsIGxlbmd0aDogbn0pXG4gIH1cbiAgaXRlbXMucHVzaCh7dGV4dDogJ1RhYnMnLCBsZW5ndGg6ICd0YWInfSlcbiAgc2VsZWN0b3Iuc2hvdyhpdGVtcywgKHt0ZXh0LCBsZW5ndGh9PXt9KSA9PntcbiAgICBjb25zdCBlZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKClcbiAgICBpZiAodGV4dCA9PSAnQXV0b21hdGljJykge1xuICAgICAgbWFudWFsLmRlbGV0ZShlZGl0b3IpXG4gICAgICBydW4oZWRpdG9yKVxuICAgIH0gZWxzZSB7XG4gICAgICBzZXRTZXR0aW5ncyhlZGl0b3IsIGxlbmd0aClcbiAgICAgIG1hbnVhbC5hZGQoZWRpdG9yKVxuICAgICAgc3RhdHVzLnVwZGF0ZShlZGl0b3IpXG4gICAgfVxuICB9KVxufVxuXG5leHBvcnQgdmFyIGNvbmZpZyA9IHtcbiAgcG9zc2libGVJbmRlbnRhdGlvbnM6IHtcbiAgICB0eXBlOiAnYXJyYXknLFxuICAgIC8vIEhBQ0s6IGFycmF5IG9mIHN0cmluZ3MgYmVjYXVzZSBzZXR0aW5ncy12aWV3IGlzIGJyb2tlblxuICAgIGRlZmF1bHQ6IFsnMicsJzMnLCAnNCcsICc2JywgJzgnXSxcbiAgICBpdGVtczoge1xuICAgICAgdHlwZTogJ3N0cmluZydcbiAgICB9LFxuICAgIG9yZGVyOiAxXG4gIH0sXG4gIGVuYWJsZURlYnVnTWVzc2FnZXM6IHtcbiAgICB0eXBlOiAnYm9vbGVhbicsXG4gICAgZGVmYXVsdDogZmFsc2UsXG4gICAgb3JkZXI6IDJcbiAgfVxufVxuIl19