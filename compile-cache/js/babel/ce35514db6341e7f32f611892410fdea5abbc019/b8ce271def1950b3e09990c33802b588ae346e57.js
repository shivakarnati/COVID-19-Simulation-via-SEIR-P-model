Object.defineProperty(exports, '__esModule', {
    value: true
});
exports.activate = activate;
exports.deactivate = deactivate;

var _miscCells = require('../misc/cells');

var _atom = require('atom');

var _miscBlocksJs = require('../misc/blocks.js');

'use babel';

var subs = undefined;
var edSubs = undefined;
var marker = undefined;
var borders = [];

function activate() {
    subs = new _atom.CompositeDisposable();
    edSubs = new _atom.CompositeDisposable();

    subs.add(atom.workspace.observeActiveTextEditor(function (ed) {
        if (ed && ed.getGrammar && ed.getGrammar().id === 'source.julia') {
            if (edSubs && edSubs.dispose) {
                edSubs.dispose();
                edSubs = new _atom.CompositeDisposable();
            }
            borders = highlightCellBorders(ed, borders);

            marker = highlightCurrentCell(ed, marker, borders);

            edSubs.add(ed.onDidChangeCursorPosition(function (ev) {
                marker = highlightCurrentCell(ed, marker, borders);
            }));

            edSubs.add(ed.onDidStopChanging(function () {
                borders = highlightCellBorders(ed, borders);
                marker = highlightCurrentCell(ed, marker, borders);
            }));

            edSubs.add(ed.onDidDestroy(function () {
                marker && marker.destroy && marker.destroy();
                borders.forEach(function (m) {
                    return m.destroy();
                });
                edSubs.dispose();
            }));

            edSubs.add(ed.onDidChangeGrammar(function (grammar) {
                marker && marker.destroy && marker.destroy();
                borders.forEach(function (m) {
                    return m.destroy();
                });

                if (ed.getGrammar().id == 'source.julia') {
                    borders = highlightCellBorders(ed, borders);
                    marker = highlightCurrentCell(ed, marker, borders);
                }
            }));
        }
    }));
}

function highlightCurrentCell(ed, marker, borders) {
    if (borders.length === 0) {
        marker && marker.destroy && marker.destroy();
        return null;
    }

    var range = (0, _miscCells.getRange)(ed);

    range[1].row += 1;
    range[1].column = 0;

    if (marker && marker.destroy) {
        var mrange = marker.getBufferRange();
        if (mrange.start.row == range[0].row && mrange.end.row == range[1].row) {
            return marker;
        } else {
            marker.destroy();
        }
    }

    marker = ed.markBufferRange(range);
    ed.decorateMarker(marker, {
        type: 'line-number',
        'class': 'julia-current-cell'
    });
    ed.decorateMarker(marker, {
        type: 'line',
        'class': 'julia-current-cell'
    });

    return marker;
}

function highlightCellBorders(ed, borders) {
    borders.forEach(function (m) {
        return m.destroy();
    });

    var regexString = '^(' + atom.config.get('julia-client.uiOptions.cellDelimiter').join('|') + ')';
    var regex = new RegExp(regexString);

    var buffer = ed.getBuffer();

    borders = [];

    for (var i = 0; i <= buffer.getEndPosition().row; i++) {
        var _getLine = (0, _miscBlocksJs.getLine)(ed, i);

        var line = _getLine.line;
        var scope = _getLine.scope;

        if (regex.test(line) && scope.join('.').indexOf('comment.line') > -1) {
            var m = ed.markBufferRange([[i, 0], [i, Infinity]]);
            ed.decorateMarker(m, {
                type: 'line',
                'class': 'julia-cell-border'
            });
            borders.push(m);
        }
    }

    return borders;
}

function destroyMarkers() {
    marker && marker.destroy && marker.destroy();
    borders.forEach(function (m) {
        return m.destroy();
    });
    marker = null;
    borders = [];
}

function deactivate() {
    destroyMarkers();
    subs && subs.dispose && subs.dispose();
    edSubs && edSubs.dispose && edSubs.dispose();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL3NoaXZha3Jpc2huYWthcm5hdGkvLnZhci9hcHAvaW8uYXRvbS5BdG9tL2RhdGEvcGFja2FnZXMvanVsaWEtY2xpZW50L2xpYi91aS9jZWxsaGlnaGxpZ2h0ZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O3lCQUV5QixlQUFlOztvQkFDSixNQUFNOzs0QkFDbEIsbUJBQW1COztBQUozQyxXQUFXLENBQUE7O0FBTVgsSUFBSSxJQUFJLFlBQUEsQ0FBQTtBQUNSLElBQUksTUFBTSxZQUFBLENBQUE7QUFDVixJQUFJLE1BQU0sWUFBQSxDQUFBO0FBQ1YsSUFBSSxPQUFPLEdBQUcsRUFBRSxDQUFBOztBQUVULFNBQVMsUUFBUSxHQUFJO0FBQ3hCLFFBQUksR0FBRywrQkFBeUIsQ0FBQTtBQUNoQyxVQUFNLEdBQUcsK0JBQXlCLENBQUE7O0FBRWxDLFFBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyx1QkFBdUIsQ0FBQyxVQUFBLEVBQUUsRUFBSTtBQUNsRCxZQUFJLEVBQUUsSUFBSSxFQUFFLENBQUMsVUFBVSxJQUFJLEVBQUUsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxFQUFFLEtBQUssY0FBYyxFQUFFO0FBQzlELGdCQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsT0FBTyxFQUFFO0FBQzFCLHNCQUFNLENBQUMsT0FBTyxFQUFFLENBQUE7QUFDaEIsc0JBQU0sR0FBRywrQkFBeUIsQ0FBQTthQUNyQztBQUNELG1CQUFPLEdBQUcsb0JBQW9CLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFBOztBQUUzQyxrQkFBTSxHQUFHLG9CQUFvQixDQUFDLEVBQUUsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUE7O0FBRWxELGtCQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyx5QkFBeUIsQ0FBQyxVQUFBLEVBQUUsRUFBSTtBQUMxQyxzQkFBTSxHQUFHLG9CQUFvQixDQUFDLEVBQUUsRUFBRSxNQUFNLEVBQUUsT0FB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QTtTQUNsQjtLQUNKOztBQUVELFdBQU8sT0FBTyxDQUFBO0NBQ2pCOztBQUVELFNBQVMsY0FBYyxHQUFJO0FBQ3ZCLFVBQU0sSUFBSSxNQUFNLENBQUMsT0FBTyxJQUFJLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQTtBQUM1QyxXQUFPLENBQUMsT0FBTyxDQUFDLFVBQUEsQ0FBQztlQUFJLENBQUMsQ0FBQyxPQUFPLEVBQUU7S0FBQSxDQUFDLENBQUE7QUFDakMsVUFBTSxHQUFHLElBQUksQ0FBQTtBQUNiLFdBQU8sR0FBRyxFQUFFLENBQUE7Q0FDZjs7QUFFTSxTQUFTLFVBQVUsR0FBSTtBQUMxQixrQkFBYyxFQUFFLENBQUE7QUFDaEIsUUFBSSxJQUFJLElBQUksQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFBO0FBQ3RDLFVBQU0sSUFBSSxNQUFNLENBQUMsT0FBTyxJQUFJLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQTtDQUMvQyIsImZpbGUiOiIvaG9tZS9zaGl2YWtyaXNobmFrYXJuYXRpLy52YXIvYXBwL2lvLmF0b20uQXRvbS9kYXRhL3BhY2thZ2VzL2p1bGlhLWNsaWVudC9saWIvdWkvY2VsbGhpZ2hsaWdodGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCdcblxuaW1wb3J0IHsgZ2V0UmFuZ2UgfSBmcm9tICcuLi9taXNjL2NlbGxzJ1xuaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBnZXRMaW5lIH0gZnJvbSAnLi4vbWlzYy9ibG9ja3MuanMnXG5cbmxldCBzdWJzXG5sZXQgZWRTdWJzXG5sZXQgbWFya2VyXG5sZXQgYm9yZGVycyA9IFtdXG5cbmV4cG9ydCBmdW5jdGlvbiBhY3RpdmF0ZSAoKSB7XG4gICAgc3VicyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICBlZFN1YnMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG5cbiAgICBzdWJzLmFkZChhdG9tLndvcmtzcGFjZS5vYnNlcnZlQWN0aXZlVGV4dEVkaXRvcihlZCA9PiB7XG4gICAgICAgIGlmIChlZCAmJiBlZC5nZXRHcmFtbWFyICYmIGVkLmdldEdyYW1tYXIoKS5pZCA9PT0gJ3NvdXJjZS5qdWxpYScpIHtcbiAgICAgICAgICAgIGlmIChlZFN1YnMgJiYgZWRTdWJzLmRpc3Bvc2UpIHtcbiAgICAgICAgICAgICAgICBlZFN1YnMuZGlzcG9zZSgpXG4gICAgICAgICAgICAgICAgZWRTdWJzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYm9yZGVycyA9IGhpZ2hsaWdodENlbGxCb3JkZXJzKGVkLCBib3JkZXJzKVxuXG4gICAgICAgICAgICBtYXJrZXIgPSBoaWdobGlnaHRDdXJyZW50Q2VsbChlZCwgbWFya2VyLCBib3JkZXJzKVxuXG4gICAgICAgICAgICBlZFN1YnMuYWRkKGVkLm9uRGlkQ2hhbmdlQ3Vyc29yUG9zaXRpb24oZXYgPT4ge1xuICAgICAgICAgICAgICAgIG1hcmtlciA9IGhpZ2hsaWdodEN1cnJlbnRDZWxsKGVkLCBtYXJrZXIsIGJvcmRlcnMpXG4gICAgICAgICAgICB9KSlcblxuICAgICAgICAgICAgZWRTdWJzLmFkZChlZC5vbkRpZFN0b3BDaGFuZ2luZygoKSA9PiB7XG4gICAgICAgICAgICAgICAgYm9yZGVycyA9IGhpZ2hsaWdodENlbGxCb3JkZXJzKGVkLCBib3JkZXJzKVxuICAgICAgICAgICAgICAgIG1hcmtlciA9IGhpZ2hsaWdodEN1cnJlbnRDZWxsKGVkLCBtYXJrZXIsIGJvcmRlcnMpXG4gICAgICAgICAgICB9KSlcblxuICAgICAgICAgICAgZWRTdWJzLmFkZChlZC5vbkRpZERlc3Ryb3koKCkgPT4ge1xuICAgICAgICAgICAgICAgIG1hcmtlciAmJiBtYXJrZXIuZGVzdHJveSAmJiBtYXJrZXIuZGVzdHJveSgpXG4gICAgICAgICAgICAgICAgYm9yZGVycy5mb3JFYWNoKG0gPT4gbS5kZXN0cm95KCkpXG4gICAgICAgICAgICAgICAgZWRTdWJzLmRpc3Bvc2UoKVxuICAgICAgICAgICAgfSkpXG5cbiAgICAgICAgICAgIGVkU3Vicy5hZGQoZWQub25EaWRDaGFuZ2VHcmFtbWFyKChncmFtbWFyKSA9PiB7XG4gICAgICAgICAgICAgICAgbWFya2VyICYmIG1hcmtlci5kZXN0cm95ICYmIG1hcmtlci5kZXN0cm95KClcbiAgICAgICAgICAgICAgICBib3JkZXJzLmZvckVhY2gobSA9PiBtLmRlc3Ryb3koKSlcblxuICAgICAgICAgICAgICAgIGlmIChlZC5nZXRHcmFtbWFyKCkuaWQgPT0gJ3NvdXJjZS5qdWxpYScpIHtcbiAgICAgICAgICAgICAgICAgICAgYm9yZGVycyA9IGhpZ2hsaWdodENlbGxCb3JkZXJzKGVkLCBib3JkZXJzKVxuICAgICAgICAgICAgICAgICAgICBtYXJrZXIgPSBoaWdobGlnaHRDdXJyZW50Q2VsbChlZCwgbWFya2VyLCBib3JkZXJzKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pKVxuICAgICAgICB9XG4gICAgfSkpXG59XG5cbmZ1bmN0aW9uIGhpZ2hsaWdodEN1cnJlbnRDZWxsIChlZCwgbWFya2VyLCBib3JkZXJzKSB7XG4gICAgaWYgKGJvcmRlcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIG1hcmtlciAmJiBtYXJrZXIuZGVzdHJveSAmJiBtYXJrZXIuZGVzdHJveSgpXG4gICAgICAgIHJldHVybiBudWxsXG4gICAgfVxuXG4gICAgY29uc3QgcmFuZ2UgPSBnZXRSYW5nZShlZClcblxuICAgIHJhbmdlWzFdLnJvdyArPTFcbiAgICByYW5nZVsxXS5jb2x1bW4gPSAwXG5cbiAgICBpZiAobWFya2VyICYmIG1hcmtlci5kZXN0cm95KSB7XG4gICAgICAgIGNvbnN0IG1yYW5nZSA9IG1hcmtlci5nZXRCdWZmZXJSYW5nZSgpXG4gICAgICAgIGlmIChtcmFuZ2Uuc3RhcnQucm93ID09IHJhbmdlWzBdLnJvdyAmJlxuICAgICAgICAgICAgbXJhbmdlLmVuZC5yb3cgPT0gcmFuZ2VbMV0ucm93KSB7XG4gICAgICAgICAgICByZXR1cm4gbWFya2VyXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBtYXJrZXIuZGVzdHJveSgpXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBtYXJrZXIgPSBlZC5tYXJrQnVmZmVyUmFuZ2UocmFuZ2UpXG4gICAgZWQuZGVjb3JhdGVNYXJrZXIobWFya2VyLCB7XG4gICAgICAgIHR5cGU6ICdsaW5lLW51bWJlcicsXG4gICAgICAgIGNsYXNzOiAnanVsaWEtY3VycmVudC1jZWxsJ1xuICAgIH0pXG4gICAgZWQuZGVjb3JhdGVNYXJrZXIobWFya2VyLCB7XG4gICAgICAgIHR5cGU6ICdsaW5lJyxcbiAgICAgICAgY2xhc3M6ICdqdWxpYS1jdXJyZW50LWNlbGwnXG4gICAgfSlcblxuICAgIHJldHVybiBtYXJrZXJcbn1cblxuZnVuY3Rpb24gaGlnaGxpZ2h0Q2VsbEJvcmRlcnMgKGVkLCBib3JkZXJzKSB7XG4gICAgYm9yZGVycy5mb3JFYWNoKG0gPT4gbS5kZXN0cm95KCkpXG5cbiAgICBjb25zdCByZWdleFN0cmluZyA9ICdeKCcgKyBhdG9tLmNvbmZpZy5nZXQoJ2p1bGlhLWNsaWVudC51aU9wdGlvbnMuY2VsbERlbGltaXRlcicpLmpvaW4oJ3wnKSArICcpJ1xuICAgIGNvbnN0IHJlZ2V4ID0gbmV3IFJlZ0V4cChyZWdleFN0cmluZylcblxuICAgIGNvbnN0IGJ1ZmZlciA9IGVkLmdldEJ1ZmZlcigpXG5cbiAgICBib3JkZXJzID0gW11cblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDw9IGJ1ZmZlci5nZXRFbmRQb3NpdGlvbigpLnJvdzsgaSsrKSB7XG4gICAgICAgIGNvbnN0IHsgbGluZSwgc2NvcGUgfSA9IGdldExpbmUoZWQsIGkpXG4gICAgICAgIGlmIChyZWdleC50ZXN0KGxpbmUpICYmIHNjb3BlLmpvaW4oJy4nKS5pbmRleE9mKCdjb21tZW50LmxpbmUnKSA+IC0xKSB7XG4gICAgICAgICAgICBjb25zdCBtID0gZWQubWFya0J1ZmZlclJhbmdlKFtbaSwgMF0sIFtpLCBJbmZpbml0eV1dKVxuICAgICAgICAgICAgZWQuZGVjb3JhdGVNYXJrZXIobSwge1xuICAgICAgICAgICAgICAgIHR5cGU6ICdsaW5lJyxcbiAgICAgICAgICAgICAgICBjbGFzczogJ2p1bGlhLWNlbGwtYm9yZGVyJ1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIGJvcmRlcnMucHVzaChtKVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGJvcmRlcnNcbn1cblxuZnVuY3Rpb24gZGVzdHJveU1hcmtlcnMgKCkge1xuICAgIG1hcmtlciAmJiBtYXJrZXIuZGVzdHJveSAmJiBtYXJrZXIuZGVzdHJveSgpXG4gICAgYm9yZGVycy5mb3JFYWNoKG0gPT4gbS5kZXN0cm95KCkpXG4gICAgbWFya2VyID0gbnVsbFxuICAgIGJvcmRlcnMgPSBbXVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVhY3RpdmF0ZSAoKSB7XG4gICAgZGVzdHJveU1hcmtlcnMoKVxuICAgIHN1YnMgJiYgc3Vicy5kaXNwb3NlICYmIHN1YnMuZGlzcG9zZSgpXG4gICAgZWRTdWJzICYmIGVkU3Vicy5kaXNwb3NlICYmIGVkU3Vicy5kaXNwb3NlKClcbn1cbiJdfQ==