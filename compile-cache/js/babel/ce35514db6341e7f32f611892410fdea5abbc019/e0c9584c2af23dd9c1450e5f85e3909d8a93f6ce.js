Object.defineProperty(exports, '__esModule', {
  value: true
});

var _connection = require('../connection');

var _ui = require('../ui');

'use babel';

var _webview = _ui.views.tags.webview;

function consoleLog(e) {
  var log = undefined;
  if (e.level === 0) {
    log = console.log;
  } else if (e.level === 1) {
    log = console.warn;
  } else if (e.level === 2) {
    log = console.error;
  }
  log(e.message, '\nat ' + e.sourceID + ':' + e.line);
}

// https://stackoverflow.com/a/5100158/12113178
function dataURItoBlob(dataURI) {
  // convert base64/URLEncoded data component to raw binary data held in a string
  var byteString = undefined;
  if (dataURI.split(',')[0].indexOf('base64') >= 0) byteString = atob(dataURI.split(',')[1]);else byteString = unescape(dataURI.split(',')[1]);

  // separate out the mime component
  var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

  // write the bytes of the string to a typed array
  var ia = new Uint8Array(byteString.length);
  for (var i = 0; i < byteString.length; i++) {
    ia[i] = byteString.charCodeAt(i);
  }

  return new Blob([ia], { type: mimeString });
}

exports['default'] = {
  activate: function activate() {
    var _this = this;

    _connection.client.handle({
      plot: function plot(x) {
        return _this.show(x);
      },
      plotsize: function plotsize() {
        return _this.plotSize();
      },
      ploturl: function ploturl(url) {
        return _this.ploturl(url);
      },
      jlpane: function jlpane(id, opts) {
        return _this.jlpane(id, opts);
      }
    });
    this.create();

    atom.config.observe('julia-client.uiOptions.usePlotPane', function (enabled) {
      if (enabled) {
        return _this.pane.setTitle('Plots');
      } else {
        return _this.pane.setTitle('Plots (disabled)');
      }
    });

    return atom.config.observe('julia-client.uiOptions.layouts.plotPane.defaultLocation', function (defaultLocation) {
      _this.pane.setDefaultLocation(defaultLocation);
    });
  },

  create: function create() {
    return this.pane = this.ink.PlotPane.fromId('default');
  },

  open: function open() {
    return this.pane.open({
      split: atom.config.get('julia-client.uiOptions.layouts.plotPane.split') });
  },

  ensureVisible: function ensureVisible() {
    return this.pane.ensureVisible({ split: atom.config.get('julia-client.uiOptions.layouts.plotPane.split') });
  },

  close: function close() {
    return this.pane.close();
  },

  show: function show(view) {
    this.ensureVisible();
    var v = _ui.views.render(view);
    this.pane.show(new this.ink.Pannable(v), {
      maxSize: atom.config.get('julia-client.uiOptions.maxNumberPlots')
    });
    return v;
  },

  plotSize: function plotSize() {
    var _this2 = this;

    return this.ensureVisible().then(function () {
      return {
        size: _this2.pane.size(),
        ratio: window.devicePixelRatio
      };
    });
  },

  webview: function webview(url) {
    var isDataURI = url.startsWith('data');
    if (isDataURI) {
      var object = dataURItoBlob(url);
      url = URL.createObjectURL(object);
    }

    var v = _ui.views.render(_webview({
      'class': 'blinkjl',
      src: url,
      style: 'width: 100%; height: 100%'
    }));
    v.classList.add('native-key-bindings');
    v.addEventListener('console-message', function (e) {
      return consoleLog(e);
    });
    if (isDataURI) {
      v.addEventListener('dom-ready', function (e) {
        URL.revokeObjectURL(url);
      });
    }
    return v;
  },

  ploturl: function ploturl(url) {
    var v = this.webview(url);
    this.ensureVisible();
    return this.pane.show(v, {
      maxSize: atom.config.get('julia-client.uiOptions.maxNumberPlots')
    });
  },

  jlpane: function jlpane(id, opts) {
    if (opts == null) {
      opts = {};
    }
    var v = undefined;
    if (opts.url) {
      v = this.webview(opts.url);
      if (opts.devtools) {
        v.addEventListener('dom-ready', function () {
          return v.openDevTools();
        });
      }
    }

    var pane = this.ink.HTMLPane.fromId(id);

    if (opts.close) {
      return pane.close();
    } else if (opts.destroy) {
      if (pane.closeAndDestroy) {
        return pane.closeAndDestroy();
      }
    } else {
      pane.show({
        item: v,
        icon: opts.icon,
        title: opts.title
      });

      return pane.ensureVisible({
        split: opts.split || atom.config.get('julia-client.uiOptions.layouts.plotPane.split')
      });
    }
  }
};
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL3NoaXZha3Jpc2huYWthcm5hdGkvLnZhci9hcHAvaW8uYXRvbS5BdG9tL2RhdGEvcGFja2FnZXMvanVsaWEtY2xpZW50L2xpYi9ydW50aW1lL3Bsb3RzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7MEJBRXVCLGVBQWU7O2tCQUNoQixPQUFPOztBQUg3QixXQUFXLENBQUE7O0lBS0gsUUFBTyxHQUFLLFVBQU0sSUFBSSxDQUF0QixPQUFPOztBQUVmLFNBQVMsVUFBVSxDQUFFLENBQUMsRUFBRTtBQUN0QixNQUFJLEdBQUcsWUFBQSxDQUFBO0FBQ1AsTUFBSSxDQUFDLENBQUMsS0FBSyxLQUFLLENBQUMsRUFBRTtBQUNqQixPQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQTtHQUNsQixNQUFNLElBQUksQ0FBQyxDQUFDLEtBQUssS0FBSyxDQUFDLEVBQUU7QUFDeEIsT0FBRyxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUE7R0FDbkIsTUFBTSxJQUFJLENBQUMsQ0FBQyxLQUFLLEtBQUssQ0FBQyxFQUFFO0FBQ3hCLE9BQUcsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFBO0dBQ3BCO0FBQ0QsS0FBRyxDQUFDLENBQUMsQ0FBQyxPQUFPLFlBQVUsQ0FBQyxDQUFDLFFBQVEsU0FBSSxDQUFDLENBQUMsSUFBSSxDQUFHLENBQUE7Q0FDL0M7OztBQUdELFNBQVMsYUFBYSxDQUFFLE9BQU8sRUFBRTs7QUFFL0IsTUFBSSxVQUFVLFlBQUEsQ0FBQTtBQUNkLE1BQUksT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUM1QyxVQUFVLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQSxLQUV4QyxVQUFVLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTs7O0FBR2hELE1BQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzs7O0FBR25FLE1BQUksRUFBRSxHQUFHLElBQUksVUFBVSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQTtBQUMxQyxPQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtBQUN4QyxNQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtHQUNuQzs7QUFFRCxTQUFPLElBQUksSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBQyxJQUFJLEVBQUMsVUFBVSxFQUFDLENBQUMsQ0FBQTtDQUN6Qzs7cUJBRWM7QUFDYixVQUFRLEVBQUMsb0JBQUc7OztBQUNWLHVCQUFPLE1BQU0sQ0FBQztBQUNaLFVBQUksRUFBRSxjQUFBLENBQUM7ZUFBSSxNQUFLLElBQUksQ0FBQyxDQUFDLENBQUM7T0FBQTtBQUN2QixjQUFRLEVBQUU7ZUFBTSxNQUFLLFFBQVEsRUFBRTtPQUFBO0FBQy9CLGFBQU8sRUFBRSxpQkFBQSxHQUFHO2VBQUksTUFBSyxPQUFPLENBQUMsR0FBRyxDQUFDO09BQUE7QUFDakMsWUFBTSxFQUFFLGdCQUFDLEVBQUUsRUFBRSxJQUFJO2VBQUssTUFBSyxNQUFNLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQztPQUFBO0tBQzVDLENBQUMsQ0FBQTtBQUNGLFFBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQTs7QUFFYixRQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxvQ0FBb0MsRUFBRSxVQUFBLE9BQU8sRUFBSTtBQUNuRSxVQUFJLE9BQU8sRUFBRTtBQUNYLGVBQU8sTUFBSyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFBO09BQ25DLE1BQU07QUFDTCxlQUFPLE1BQUssSUFBSSxDQUFDLFFBQVEsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFBO09BQzlDO0tBQ0YsQ0FBQyxDQUFBOztBQUVGLFdBQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMseURBQXlELEVBQUUsVUFBQSxlQUFlLEVBQUk7QUFDdkcsWUFBSyxJQUFJLENBQUMsa0JBQWtCLENBQUMsZUFBZSxDQUFDLENBQUE7S0FDOUMsQ0FBQyxDQUFBO0dBQ0g7O0FBRUQsUUFBTSxFQUFDLGtCQUFHO0FBQ1IsV0FBTyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQTtHQUN2RDs7QUFFRCxNQUFJLEVBQUMsZ0JBQUc7QUFDTixXQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO0FBQ3BCLFdBQUssRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQywrQ0FBK0MsQ0FBQyxFQUFDLENBQUMsQ0FBQTtHQUM1RTs7QUFFRCxlQUFhLEVBQUMseUJBQUc7QUFDZixXQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLCtDQUErQyxDQUFDLEVBQUUsQ0FBQyxDQUFBO0dBQzVHOztBQUVELE9BQUssRUFBQyxpQkFBRztBQUNQLFdBQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQTtHQUN6Qjs7QUFFRCxNQUFJLEVBQUMsY0FBQyxJQUFJLEVBQUU7QUFDVixRQUFJLENBQUMsYUFBYSxFQUFFLENBQUE7QUFDcEIsUUFBTSxDQUFDLEdBQUcsVUFBTSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUE7QUFDNUIsUUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRTtBQUN2QyxhQUFPLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsdUNBQXVDLENBQUM7S0FDbEUsQ0FBQyxDQUFBO0FBQ0YsV0FBTyxDQUFDLENBQUE7R0FDVDs7QUFFRCxVQUFRLEVBQUMsb0JBQUc7OztBQUNWLFdBQU8sSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFNO0FBQ3JDLGFBQU87QUFDTCxZQUFJLEVBQUUsT0FBSyxJQUFJLENBQUMsSUFBSSxFQUFFO0FBQ3RCLGFBQUssRUFBRSxNQUFNLENBQUMsZ0JBQWdCO09BQy9CLENBQUE7S0FDRixDQUFDLENBQUE7R0FDSDs7QUFFRCxTQUFPLEVBQUMsaUJBQUMsR0FBRyxFQUFFO0FBQ1osUUFBTSxTQUFTLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQTtBQUN4QyxRQUFJLFNBQVMsRUFBRTtBQUNiLFVBQU0sTUFBTSxHQUFHLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQTtBQUNqQyxTQUFHLEdBQUcsR0FBRyxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQTtLQUNsQzs7QUFFRCxRQUFNLENBQUMsR0FBRyxVQUFNLE1BQU0sQ0FBQyxRQUFPLENBQUM7QUFDN0IsZUFBTyxTQUFTO0FBQ2hCLFNBQUcsRUFBRSxHQUFHO0FBQ1IsV0FBSyxFQUFFLDJCQUEyQjtLQUNuQyxDQUFDLENBQUMsQ0FBQTtBQUNILEtBQUMsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDLENBQUE7QUFDdEMsS0FBQyxDQUFDLGdCQUFnQixDQUFDLGlCQUFpQixFQUFFLFVBQUEsQ0FBQzthQUFJLFVBQVUsQ0FBQyxDQUFDLENBQUM7S0FBQSxDQUFDLENBQUE7QUFDekQsUUFBSSxTQUFTLEVBQUU7QUFDYixPQUFDLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxFQUFFLFVBQUEsQ0FBQyxFQUFJO0FBQ25DLFdBQUcsQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUE7T0FDekIsQ0FBQyxDQUFBO0tBQ0g7QUFDRCxXQUFPLENBQUMsQ0FBQTtHQUNUOztBQUVELFNBQU8sRUFBQyxpQkFBQyxHQUFHLEVBQUU7QUFDWixRQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFBO0FBQzNCLFFBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQTtBQUNwQixXQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRTtBQUN2QixhQUFPLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsdUNBQXVDLENBQUM7S0FDbEUsQ0FBQyxDQUFBO0dBQ0g7O0FBRUQsUUFBTSxFQUFDLGdCQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUU7QUFDaEIsUUFBSSxJQUFJLElBQUksSUFBSSxFQUFFO0FBQUUsVUFBSSxHQUFHLEVBQUUsQ0FBQTtLQUFFO0FBQy9CLFFBQUksQ0FBQyxHQUFHLFNBQVMsQ0FBQTtBQUNqQixRQUFJLElBQUksQ0FBQyxHQUFHLEVBQUU7QUFDWixPQUFDLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7QUFDMUIsVUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO0FBQ2pCLFNBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsWUFBTTtBQUNwQyxpQkFBTyxDQUFDLENBQUMsWUFBWSxFQUFFLENBQUE7U0FDeEIsQ0FBQyxDQUFBO09BQ0g7S0FDRjs7QUFFRCxRQUFNLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUE7O0FBRXpDLFFBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtBQUNkLGFBQU8sSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFBO0tBQ3BCLE1BQU0sSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFO0FBQ3ZCLFVBQUksSUFBSSxDQUFDLGVBQWUsRUFBRTtBQUN4QixlQUFPLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQTtPQUM5QjtLQUNGLE1BQU07QUFDTCxVQUFJLENBQUMsSUFBSSxDQUFDO0FBQ1IsWUFBSSxFQUFFLENBQUM7QUFDUCxZQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7QUFDZixhQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUs7T0FDbEIsQ0FBQyxDQUFBOztBQUVGLGFBQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQztBQUN4QixhQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQywrQ0FBK0MsQ0FBQztPQUN0RixDQUFDLENBQUE7S0FDSDtHQUNGO0NBQ0YiLCJmaWxlIjoiL2hvbWUvc2hpdmFrcmlzaG5ha2FybmF0aS8udmFyL2FwcC9pby5hdG9tLkF0b20vZGF0YS9wYWNrYWdlcy9qdWxpYS1jbGllbnQvbGliL3J1bnRpbWUvcGxvdHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJ1xuXG5pbXBvcnQgeyBjbGllbnQgfSBmcm9tICcuLi9jb25uZWN0aW9uJ1xuaW1wb3J0IHsgdmlld3MgfSBmcm9tICcuLi91aSdcblxuY29uc3QgeyB3ZWJ2aWV3IH0gPSB2aWV3cy50YWdzXG5cbmZ1bmN0aW9uIGNvbnNvbGVMb2cgKGUpIHtcbiAgbGV0IGxvZ1xuICBpZiAoZS5sZXZlbCA9PT0gMCkge1xuICAgIGxvZyA9IGNvbnNvbGUubG9nXG4gIH0gZWxzZSBpZiAoZS5sZXZlbCA9PT0gMSkge1xuICAgIGxvZyA9IGNvbnNvbGUud2FyblxuICB9IGVsc2UgaWYgKGUubGV2ZWwgPT09IDIpIHtcbiAgICBsb2cgPSBjb25zb2xlLmVycm9yXG4gIH1cbiAgbG9nKGUubWVzc2FnZSwgYFxcbmF0ICR7ZS5zb3VyY2VJRH06JHtlLmxpbmV9YClcbn1cblxuLy8gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9hLzUxMDAxNTgvMTIxMTMxNzhcbmZ1bmN0aW9uIGRhdGFVUkl0b0Jsb2IgKGRhdGFVUkkpIHtcbiAgLy8gY29udmVydCBiYXNlNjQvVVJMRW5jb2RlZCBkYXRhIGNvbXBvbmVudCB0byByYXcgYmluYXJ5IGRhdGEgaGVsZCBpbiBhIHN0cmluZ1xuICBsZXQgYnl0ZVN0cmluZ1xuICBpZiAoZGF0YVVSSS5zcGxpdCgnLCcpWzBdLmluZGV4T2YoJ2Jhc2U2NCcpID49IDApXG4gICAgICBieXRlU3RyaW5nID0gYXRvYihkYXRhVVJJLnNwbGl0KCcsJylbMV0pXG4gIGVsc2VcbiAgICAgIGJ5dGVTdHJpbmcgPSB1bmVzY2FwZShkYXRhVVJJLnNwbGl0KCcsJylbMV0pXG5cbiAgLy8gc2VwYXJhdGUgb3V0IHRoZSBtaW1lIGNvbXBvbmVudFxuICB2YXIgbWltZVN0cmluZyA9IGRhdGFVUkkuc3BsaXQoJywnKVswXS5zcGxpdCgnOicpWzFdLnNwbGl0KCc7JylbMF07XG5cbiAgLy8gd3JpdGUgdGhlIGJ5dGVzIG9mIHRoZSBzdHJpbmcgdG8gYSB0eXBlZCBhcnJheVxuICB2YXIgaWEgPSBuZXcgVWludDhBcnJheShieXRlU3RyaW5nLmxlbmd0aClcbiAgZm9yICh2YXIgaSA9IDA7IGkgPCBieXRlU3RyaW5nLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpYVtpXSA9IGJ5dGVTdHJpbmcuY2hhckNvZGVBdChpKVxuICB9XG5cbiAgcmV0dXJuIG5ldyBCbG9iKFtpYV0sIHt0eXBlOm1pbWVTdHJpbmd9KVxufVxuXG5leHBvcnQgZGVmYXVsdCB7XG4gIGFjdGl2YXRlICgpIHtcbiAgICBjbGllbnQuaGFuZGxlKHtcbiAgICAgIHBsb3Q6IHggPT4gdGhpcy5zaG93KHgpLFxuICAgICAgcGxvdHNpemU6ICgpID0+IHRoaXMucGxvdFNpemUoKSxcbiAgICAgIHBsb3R1cmw6IHVybCA9PiB0aGlzLnBsb3R1cmwodXJsKSxcbiAgICAgIGpscGFuZTogKGlkLCBvcHRzKSA9PiB0aGlzLmpscGFuZShpZCwgb3B0cylcbiAgICB9KVxuICAgIHRoaXMuY3JlYXRlKClcblxuICAgIGF0b20uY29uZmlnLm9ic2VydmUoJ2p1bGlhLWNsaWVudC51aU9wdGlvbnMudXNlUGxvdFBhbmUnLCBlbmFibGVkID0+IHtcbiAgICAgIGlmIChlbmFibGVkKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnBhbmUuc2V0VGl0bGUoJ1Bsb3RzJylcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0aGlzLnBhbmUuc2V0VGl0bGUoJ1Bsb3RzIChkaXNhYmxlZCknKVxuICAgICAgfVxuICAgIH0pXG5cbiAgICByZXR1cm4gYXRvbS5jb25maWcub2JzZXJ2ZSgnanVsaWEtY2xpZW50LnVpT3B0aW9ucy5sYXlvdXRzLnBsb3RQYW5lLmRlZmF1bHRMb2NhdGlvbicsIGRlZmF1bHRMb2NhdGlvbiA9PiB7XG4gICAgICB0aGlzLnBhbmUuc2V0RGVmYXVsdExvY2F0aW9uKGRlZmF1bHRMb2NhdGlvbilcbiAgICB9KVxuICB9LFxuXG4gIGNyZWF0ZSAoKSB7XG4gICAgcmV0dXJuIHRoaXMucGFuZSA9IHRoaXMuaW5rLlBsb3RQYW5lLmZyb21JZCgnZGVmYXVsdCcpXG4gIH0sXG5cbiAgb3BlbiAoKSB7XG4gICAgcmV0dXJuIHRoaXMucGFuZS5vcGVuKHtcbiAgICAgIHNwbGl0OiBhdG9tLmNvbmZpZy5nZXQoJ2p1bGlhLWNsaWVudC51aU9wdGlvbnMubGF5b3V0cy5wbG90UGFuZS5zcGxpdCcpfSlcbiAgfSxcblxuICBlbnN1cmVWaXNpYmxlICgpIHtcbiAgICByZXR1cm4gdGhpcy5wYW5lLmVuc3VyZVZpc2libGUoeyBzcGxpdDogYXRvbS5jb25maWcuZ2V0KCdqdWxpYS1jbGllbnQudWlPcHRpb25zLmxheW91dHMucGxvdFBhbmUuc3BsaXQnKSB9KVxuICB9LFxuXG4gIGNsb3NlICgpIHtcbiAgICByZXR1cm4gdGhpcy5wYW5lLmNsb3NlKClcbiAgfSxcblxuICBzaG93ICh2aWV3KSB7XG4gICAgdGhpcy5lbnN1cmVWaXNpYmxlKClcbiAgICBjb25zdCB2ID0gdmlld3MucmVuZGVyKHZpZXcpXG4gICAgdGhpcy5wYW5lLnNob3cobmV3IHRoaXMuaW5rLlBhbm5hYmxlKHYpLCB7XG4gICAgICBtYXhTaXplOiBhdG9tLmNvbmZpZy5nZXQoJ2p1bGlhLWNsaWVudC51aU9wdGlvbnMubWF4TnVtYmVyUGxvdHMnKVxuICAgIH0pXG4gICAgcmV0dXJuIHZcbiAgfSxcblxuICBwbG90U2l6ZSAoKSB7XG4gICAgcmV0dXJuIHRoaXMuZW5zdXJlVmlzaWJsZSgpLnRoZW4oKCkgPT4ge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc2l6ZTogdGhpcy5wYW5lLnNpemUoKSxcbiAgICAgICAgcmF0aW86IHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvXG4gICAgICB9XG4gICAgfSlcbiAgfSxcblxuICB3ZWJ2aWV3ICh1cmwpIHtcbiAgICBjb25zdCBpc0RhdGFVUkkgPSB1cmwuc3RhcnRzV2l0aCgnZGF0YScpXG4gICAgaWYgKGlzRGF0YVVSSSkge1xuICAgICAgY29uc3Qgb2JqZWN0ID0gZGF0YVVSSXRvQmxvYih1cmwpXG4gICAgICB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKG9iamVjdClcbiAgICB9XG5cbiAgICBjb25zdCB2ID0gdmlld3MucmVuZGVyKHdlYnZpZXcoe1xuICAgICAgY2xhc3M6ICdibGlua2psJyxcbiAgICAgIHNyYzogdXJsLFxuICAgICAgc3R5bGU6ICd3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlJ1xuICAgIH0pKVxuICAgIHYuY2xhc3NMaXN0LmFkZCgnbmF0aXZlLWtleS1iaW5kaW5ncycpXG4gICAgdi5hZGRFdmVudExpc3RlbmVyKCdjb25zb2xlLW1lc3NhZ2UnLCBlID0+IGNvbnNvbGVMb2coZSkpXG4gICAgaWYgKGlzRGF0YVVSSSkge1xuICAgICAgdi5hZGRFdmVudExpc3RlbmVyKCdkb20tcmVhZHknLCBlID0+IHtcbiAgICAgICAgVVJMLnJldm9rZU9iamVjdFVSTCh1cmwpXG4gICAgICB9KVxuICAgIH1cbiAgICByZXR1cm4gdlxuICB9LFxuXG4gIHBsb3R1cmwgKHVybCkge1xuICAgIGNvbnN0IHYgPSB0aGlzLndlYnZpZXcodXJsKVxuICAgIHRoaXMuZW5zdXJlVmlzaWJsZSgpXG4gICAgcmV0dXJuIHRoaXMucGFuZS5zaG93KHYsIHtcbiAgICAgIG1heFNpemU6IGF0b20uY29uZmlnLmdldCgnanVsaWEtY2xpZW50LnVpT3B0aW9ucy5tYXhOdW1iZXJQbG90cycpXG4gICAgfSlcbiAgfSxcblxuICBqbHBhbmUgKGlkLCBvcHRzKSB7XG4gICAgaWYgKG9wdHMgPT0gbnVsbCkgeyBvcHRzID0ge30gfVxuICAgIGxldCB2ID0gdW5kZWZpbmVkXG4gICAgaWYgKG9wdHMudXJsKSB7XG4gICAgICB2ID0gdGhpcy53ZWJ2aWV3KG9wdHMudXJsKVxuICAgICAgaWYgKG9wdHMuZGV2dG9vbHMpIHtcbiAgICAgICAgdi5hZGRFdmVudExpc3RlbmVyKCdkb20tcmVhZHknLCAoKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHYub3BlbkRldlRvb2xzKClcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBwYW5lID0gdGhpcy5pbmsuSFRNTFBhbmUuZnJvbUlkKGlkKVxuXG4gICAgaWYgKG9wdHMuY2xvc2UpIHtcbiAgICAgIHJldHVybiBwYW5lLmNsb3NlKClcbiAgICB9IGVsc2UgaWYgKG9wdHMuZGVzdHJveSkge1xuICAgICAgaWYgKHBhbmUuY2xvc2VBbmREZXN0cm95KSB7XG4gICAgICAgIHJldHVybiBwYW5lLmNsb3NlQW5kRGVzdHJveSgpXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhbmUuc2hvdyh7XG4gICAgICAgIGl0ZW06IHYsXG4gICAgICAgIGljb246IG9wdHMuaWNvbixcbiAgICAgICAgdGl0bGU6IG9wdHMudGl0bGVcbiAgICAgIH0pXG5cbiAgICAgIHJldHVybiBwYW5lLmVuc3VyZVZpc2libGUoe1xuICAgICAgICBzcGxpdDogb3B0cy5zcGxpdCB8fCBhdG9tLmNvbmZpZy5nZXQoJ2p1bGlhLWNsaWVudC51aU9wdGlvbnMubGF5b3V0cy5wbG90UGFuZS5zcGxpdCcpXG4gICAgICB9KVxuICAgIH1cbiAgfVxufVxuIl19