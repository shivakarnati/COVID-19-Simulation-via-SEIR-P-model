Object.defineProperty(exports, '__esModule', {
  value: true
});
exports.activate = activate;
exports.open = open;
exports.close = close;
exports.deactivate = deactivate;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _atom = require('atom');

var _underscorePlus = require('underscore-plus');

var _connection = require('../connection');

var _modules = require('./modules');

var _modules2 = _interopRequireDefault(_modules);

'use babel';

var updateeditor = _connection.client['import']('updateeditor');
var pane = undefined,
    subs = undefined,
    edSubs = undefined,
    outline = undefined;

function activate(ink) {
  pane = ink.Outline.fromId('Julia-Outline');
  subs = new _atom.CompositeDisposable();
  edSubs = new _atom.CompositeDisposable();
  outline = [];

  subs.add(atom.config.observe('julia-client.uiOptions.layouts.outline.defaultLocation', function (defaultLocation) {
    pane.setDefaultLocation(defaultLocation);
  }), atom.workspace.onDidStopChangingActivePaneItem((0, _underscorePlus.throttle)(function (ed) {
    return watchEditor(ed);
  }, 300)), atom.packages.onDidActivateInitialPackages(function () {
    return watchEditor(atom.workspace.getActivePaneItem());
  }), _connection.client.onDetached(function () {
    outline = [];
    pane.setItems([]);
  }), new _atom.Disposable(function () {
    outline = [];
    pane.setItems([]);
    if (edSubs) edSubs.dispose();
  }));
}

function watchEditor(ed) {
  if (!(ed && ed instanceof _atom.TextEditor)) return;

  if (edSubs) edSubs.dispose();
  edSubs = new _atom.CompositeDisposable(); // we can't repeat disposing on the same `CompositeDisposable` object

  if (ed.getGrammar().id !== 'source.julia') {
    pane.setItems([]);
  } else {
    edSubs.add(ed.onDidStopChanging((0, _underscorePlus.throttle)(function () {
      return updateEditor(ed);
    }, 300)), ed.onDidChangeCursorPosition((0, _underscorePlus.throttle)(function () {
      return updateOutline(ed);
    }, 300)));
    updateEditor(ed, { updateSymbols: false });
  }
  edSubs.add(ed.onDidDestroy(function () {
    outline = [];
    pane.setItems([]);
  }), ed.onDidChangeGrammar(function (grammar) {
    watchEditor(ed);
  }));
}

// NOTE: update outline and symbols cache all in one go
function updateEditor(ed) {
  var options = arguments.length <= 1 || arguments[1] === undefined ? {
    updateSymbols: true
  } : arguments[1];

  if (!_connection.client.isActive()) return new Promise(function (resolve) {
    return resolve([]);
  });

  var text = ed.getText();
  var currentModule = _modules2['default'].current();
  var mod = currentModule ? currentModule : 'Main';
  var path = ed.getPath() || 'untitled-' + ed.getBuffer().getId();

  updateeditor({
    text: text,
    mod: mod,
    path: path,
    // https://github.com/JunoLab/Juno.jl/issues/407
    updateSymbols: options.updateSymbols
  }).then(function (outlineItems) {
    outline = handleOutline(ed, outlineItems);
  })['catch'](function (err) {
    console.log(err);
  });
}

function handleOutline(ed, outlineItems) {
  var cursorLine = ed.getCursorBufferPosition().row + 1;

  outlineItems = outlineItems.map(function (outlineItem) {
    outlineItem.isActive = outlineItem.start <= cursorLine && cursorLine <= outlineItem.stop;
    outlineItem.onClick = function () {
      for (var _pane of atom.workspace.getPanes()) {
        if (_pane.getItems().includes(ed)) {
          _pane.activate();
          _pane.setActiveItem(ed);
          ed.setCursorBufferPosition([outlineItem.start - 1, 0]);
          ed.scrollToCursorPosition();
          break;
        }
      }
    };
    return outlineItem;
  });

  pane.setItems(outlineItems);
  return outlineItems;
}

function updateOutline(ed) {
  var cursorLine = ed.getCursorBufferPosition().row + 1;
  outline = outline.map(function (item) {
    item.isActive = item.start <= cursorLine && cursorLine <= item.stop;
    return item;
  });
  pane.setItems(outline);
}

function open() {
  return pane.open({
    split: atom.config.get('julia-client.uiOptions.layouts.outline.split')
  });
}

function close() {
  return pane.close();
}

function deactivate() {
  if (subs) subs.dispose();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL3NoaXZha3Jpc2huYWthcm5hdGkvLnZhci9hcHAvaW8uYXRvbS5BdG9tL2RhdGEvcGFja2FnZXMvanVsaWEtY2xpZW50L2xpYi9ydW50aW1lL291dGxpbmUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztvQkFFNEQsTUFBTTs7OEJBQ3pDLGlCQUFpQjs7MEJBQ25CLGVBQWU7O3VCQUNsQixXQUFXOzs7O0FBTC9CLFdBQVcsQ0FBQTs7QUFPWCxJQUFNLFlBQVksR0FBRyw0QkFBYSxDQUFDLGNBQWMsQ0FBQyxDQUFBO0FBQ2xELElBQUksSUFBSSxZQUFBO0lBQUUsSUFBSSxZQUFBO0lBQUUsTUFBTSxZQUFBO0lBQUUsT0FBTyxZQUFBLENBQUE7O0FBRXhCLFNBQVMsUUFBUSxDQUFFLEdBQUcsRUFBRTtBQUM3QixNQUFJLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUE7QUFDMUMsTUFBSSxHQUFHLCtCQUF5QixDQUFBO0FBQ2hDLFFBQU0sR0FBRywrQkFBeUIsQ0FBQTtBQUNsQyxTQUFPLEdBQUcsRUFBRSxDQUFBOztBQUVaLE1BQUksQ0FBQyxHQUFHLENBQ04sSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsd0RBQXdELEVBQUUsVUFBQSxlQUFlLEVBQUk7QUFDL0YsUUFBSSxDQUFDLGtCQUFrQixDQUFDLGVBQWUsQ0FBQyxDQUFBO0dBQ3pDLENBQUMsRUFDRixJQUFJLENBQUMsU0FBUyxDQUFDLCtCQUErQixDQUFDLDhCQUFTLFVBQUEsRUFBRTtXQUFJLFdBQVcsQ0FBQyxFQUFFLENBQUM7R0FBQSxFQUFFLEdBQUcsQ0FBQyxDQUFDLEVBQ3BGLElBQUksQ0FBQyxRQUFRLENBQUMsNEJBQTRCLENBQUM7V0FBTSxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO0dBQUEsQ0FBQyxFQUNqRyxtQkFBTyxVQUFVLENBQUMsWUFBTTtBQUN0QixXQUFP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QUNGLE1BQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUE7Q0FDdkI7O0FBRU0sU0FBUyxJQUFJLEdBQUk7QUFDdEIsU0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO0FBQ2YsU0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLDhDQUE4QyxDQUFDO0dBQ3ZFLENBQUMsQ0FBQTtDQUNIOztBQUVNLFNBQVMsS0FBSyxHQUFJO0FBQ3ZCLFNBQU8sSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFBO0NBQ3BCOztBQUVNLFNBQVMsVUFBVSxHQUFJO0FBQzVCLE1BQUksSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQTtDQUN6QiIsImZpbGUiOiIvaG9tZS9zaGl2YWtyaXNobmFrYXJuYXRpLy52YXIvYXBwL2lvLmF0b20uQXRvbS9kYXRhL3BhY2thZ2VzL2p1bGlhLWNsaWVudC9saWIvcnVudGltZS9vdXRsaW5lLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCdcblxuaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSwgRGlzcG9zYWJsZSwgVGV4dEVkaXRvciB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyB0aHJvdHRsZSB9IGZyb20gJ3VuZGVyc2NvcmUtcGx1cydcbmltcG9ydCB7IGNsaWVudCB9IGZyb20gJy4uL2Nvbm5lY3Rpb24nXG5pbXBvcnQgbW9kdWxlcyBmcm9tICcuL21vZHVsZXMnXG5cbmNvbnN0IHVwZGF0ZWVkaXRvciA9IGNsaWVudC5pbXBvcnQoJ3VwZGF0ZWVkaXRvcicpXG5sZXQgcGFuZSwgc3VicywgZWRTdWJzLCBvdXRsaW5lXG5cbmV4cG9ydCBmdW5jdGlvbiBhY3RpdmF0ZSAoaW5rKSB7XG4gIHBhbmUgPSBpbmsuT3V0bGluZS5mcm9tSWQoJ0p1bGlhLU91dGxpbmUnKVxuICBzdWJzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICBlZFN1YnMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gIG91dGxpbmUgPSBbXVxuXG4gIHN1YnMuYWRkKFxuICAgIGF0b20uY29uZmlnLm9ic2VydmUoJ2p1bGlhLWNsaWVudC51aU9wdGlvbnMubGF5b3V0cy5vdXRsaW5lLmRlZmF1bHRMb2NhdGlvbicsIGRlZmF1bHRMb2NhdGlvbiA9PiB7XG4gICAgICBwYW5lLnNldERlZmF1bHRMb2NhdGlvbihkZWZhdWx0TG9jYXRpb24pXG4gICAgfSksXG4gICAgYXRvbS53b3Jrc3BhY2Uub25EaWRTdG9wQ2hhbmdpbmdBY3RpdmVQYW5lSXRlbSh0aHJvdHRsZShlZCA9PiB3YXRjaEVkaXRvcihlZCksIDMwMCkpLFxuICAgIGF0b20ucGFja2FnZXMub25EaWRBY3RpdmF0ZUluaXRpYWxQYWNrYWdlcygoKSA9PiB3YXRjaEVkaXRvcihhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVQYW5lSXRlbSgpKSksXG4gICAgY2xpZW50Lm9uRGV0YWNoZWQoKCkgPT4ge1xuICAgICAgb3V0bGluZSA9IFtdXG4gICAgICBwYW5lLnNldEl0ZW1zKFtdKVxuICAgIH0pLFxuICAgIG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICAgIG91dGxpbmUgPSBbXVxuICAgICAgcGFuZS5zZXRJdGVtcyhbXSlcbiAgICAgIGlmIChlZFN1YnMpIGVkU3Vicy5kaXNwb3NlKClcbiAgICB9KVxuICApXG59XG5cbmZ1bmN0aW9uIHdhdGNoRWRpdG9yIChlZCkge1xuICBpZiAoIShlZCAmJiBlZCBpbnN0YW5jZW9mIFRleHRFZGl0b3IpKSByZXR1cm5cblxuICBpZiAoZWRTdWJzKSBlZFN1YnMuZGlzcG9zZSgpXG4gIGVkU3VicyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCkgLy8gd2UgY2FuJ3QgcmVwZWF0IGRpc3Bvc2luZyBvbiB0aGUgc2FtZSBgQ29tcG9zaXRlRGlzcG9zYWJsZWAgb2JqZWN0XG5cbiAgaWYgKGVkLmdldEdyYW1tYXIoKS5pZCAhPT0gJ3NvdXJjZS5qdWxpYScpIHtcbiAgICBwYW5lLnNldEl0ZW1zKFtdKVxuICB9IGVsc2Uge1xuICAgIGVkU3Vicy5hZGQoXG4gICAgICBlZC5vbkRpZFN0b3BDaGFuZ2luZyh0aHJvdHRsZSgoKSA9PiB1cGRhdGVFZGl0b3IoZWQpLCAzMDApKSxcbiAgICAgIGVkLm9uRGlkQ2hhbmdlQ3Vyc29yUG9zaXRpb24odGhyb3R0bGUoKCkgPT4gdXBkYXRlT3V0bGluZShlZCksIDMwMCkpXG4gICAgKVxuICAgIHVwZGF0ZUVkaXRvcihlZCwgeyB1cGRhdGVTeW1ib2xzOiBmYWxzZSB9KVxuICB9XG4gIGVkU3Vicy5hZGQoXG4gICAgZWQub25EaWREZXN0cm95KCgpID0+IHtcbiAgICAgIG91dGxpbmUgPSBbXVxuICAgICAgcGFuZS5zZXRJdGVtcyhbXSlcbiAgICB9KSxcbiAgICBlZC5vbkRpZENoYW5nZUdyYW1tYXIoZ3JhbW1hciA9PiB7XG4gICAgICB3YXRjaEVkaXRvcihlZClcbiAgICB9KVxuICApXG59XG5cbi8vIE5PVEU6IHVwZGF0ZSBvdXRsaW5lIGFuZCBzeW1ib2xzIGNhY2hlIGFsbCBpbiBvbmUgZ29cbmZ1bmN0aW9uIHVwZGF0ZUVkaXRvciAoZWQsIG9wdGlvbnMgPSB7XG4gIHVwZGF0ZVN5bWJvbHM6IHRydWVcbn0pIHtcbiAgaWYgKCFjbGllbnQuaXNBY3RpdmUoKSkgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4gcmVzb2x2ZShbXSkpXG5cbiAgY29uc3QgdGV4dCA9IGVkLmdldFRleHQoKVxuICBjb25zdCBjdXJyZW50TW9kdWxlID0gbW9kdWxlcy5jdXJyZW50KClcbiAgY29uc3QgbW9kID0gY3VycmVudE1vZHVsZSA/IGN1cnJlbnRNb2R1bGUgOiAnTWFpbidcbiAgY29uc3QgcGF0aCA9IGVkLmdldFBhdGgoKSB8fCAndW50aXRsZWQtJyArIGVkLmdldEJ1ZmZlcigpLmdldElkKClcblxuICB1cGRhdGVlZGl0b3Ioe1xuICAgIHRleHQsXG4gICAgbW9kLFxuICAgIHBhdGgsXG4gICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL0p1bm9MYWIvSnVuby5qbC9pc3N1ZXMvNDA3XG4gICAgdXBkYXRlU3ltYm9sczogb3B0aW9ucy51cGRhdGVTeW1ib2xzXG4gIH0pLnRoZW4ob3V0bGluZUl0ZW1zID0+IHtcbiAgICBvdXRsaW5lID0gaGFuZGxlT3V0bGluZShlZCwgb3V0bGluZUl0ZW1zKVxuICB9KS5jYXRjaChlcnIgPT4ge1xuICAgIGNvbnNvbGUubG9nKGVycik7XG4gIH0pXG59XG5cbmZ1bmN0aW9uIGhhbmRsZU91dGxpbmUgKGVkLCBvdXRsaW5lSXRlbXMpIHtcbiAgY29uc3QgY3Vyc29yTGluZSA9IGVkLmdldEN1cnNvckJ1ZmZlclBvc2l0aW9uKCkucm93ICsgMVxuXG4gIG91dGxpbmVJdGVtcyA9IG91dGxpbmVJdGVtcy5tYXAob3V0bGluZUl0ZW0gPT4ge1xuICAgIG91dGxpbmVJdGVtLmlzQWN0aXZlID0gb3V0bGluZUl0ZW0uc3RhcnQgPD0gY3Vyc29yTGluZSAmJiBjdXJzb3JMaW5lIDw9IG91dGxpbmVJdGVtLnN0b3BcbiAgICBvdXRsaW5lSXRlbS5vbkNsaWNrID0gKCkgPT4ge1xuICAgICAgZm9yIChjb25zdCBwYW5lIG9mIGF0b20ud29ya3NwYWNlLmdldFBhbmVzKCkpIHtcbiAgICAgICAgaWYgKHBhbmUuZ2V0SXRlbXMoKS5pbmNsdWRlcyhlZCkpIHtcbiAgICAgICAgICBwYW5lLmFjdGl2YXRlKClcbiAgICAgICAgICBwYW5lLnNldEFjdGl2ZUl0ZW0oZWQpXG4gICAgICAgICAgZWQuc2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oW291dGxpbmVJdGVtLnN0YXJ0IC0gMSwgMF0pXG4gICAgICAgICAgZWQuc2Nyb2xsVG9DdXJzb3JQb3NpdGlvbigpXG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gb3V0bGluZUl0ZW1cbiAgfSlcblxuICBwYW5lLnNldEl0ZW1zKG91dGxpbmVJdGVtcylcbiAgcmV0dXJuIG91dGxpbmVJdGVtc1xufVxuXG5mdW5jdGlvbiB1cGRhdGVPdXRsaW5lIChlZCkge1xuICBjb25zdCBjdXJzb3JMaW5lID0gZWQuZ2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oKS5yb3cgKyAxXG4gIG91dGxpbmUgPSBvdXRsaW5lLm1hcChpdGVtID0+IHtcbiAgICBpdGVtLmlzQWN0aXZlID0gaXRlbS5zdGFydCA8PSBjdXJzb3JMaW5lICYmIGN1cnNvckxpbmUgPD0gaXRlbS5zdG9wXG4gICAgcmV0dXJuIGl0ZW1cbiAgfSlcbiAgcGFuZS5zZXRJdGVtcyhvdXRsaW5lKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gb3BlbiAoKSB7XG4gIHJldHVybiBwYW5lLm9wZW4oe1xuICAgIHNwbGl0OiBhdG9tLmNvbmZpZy5nZXQoJ2p1bGlhLWNsaWVudC51aU9wdGlvbnMubGF5b3V0cy5vdXRsaW5lLnNwbGl0JylcbiAgfSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNsb3NlICgpIHtcbiAgcmV0dXJuIHBhbmUuY2xvc2UoKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVhY3RpdmF0ZSAoKSB7XG4gIGlmIChzdWJzKSBzdWJzLmRpc3Bvc2UoKVxufVxuIl19